<!doctype html>
<html lang="en-US">
<head>
    <title>Graderoom</title>
    <link rel="icon" href="../../public/resources/common/icon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:500&display=swap">
    <% let theme; %>
    <% let zeroTime = new Date("0/"); %>
    <% zeroTime.setHours(new Date().getHours()); %>
    <% zeroTime.setMinutes(new Date().getMinutes()); %>
    <% zeroTime = zeroTime.getTime(); %>
    <% if (JSON.parse(appearance).theme === "dark") { %>
        <% theme = true; %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="../../public/css/dark_mode.css">
    <% } else if (JSON.parse(appearance).theme === "light") { %>
        <% theme = false; %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="../../public/css/light_mode.css">
    <% } else if (JSON.parse(appearance).theme === "auto" && (((JSON.parse(appearance).darkModeStart < JSON.parse(appearance).darkModeFinish) && ((zeroTime >= JSON.parse(appearance).darkModeStart) && (zeroTime < JSON.parse(appearance).darkModeFinish))) || ((JSON.parse(appearance).darkModeStart > JSON.parse(appearance).darkModeFinish) && ((zeroTime >= JSON.parse(appearance).darkModeStart) || (zeroTime < JSON.parse(appearance).darkModeFinish))))) { %>
        <% theme = true; %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="../../public/css/dark_mode.css">
    <% } else if ((zeroTime >= sunset.getTime()) || (zeroTime <= sunrise.getTime())) { %>
        <% theme = true; %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="../../public/css/dark_mode.css">
    <% } else { %>
        <% theme = false; %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="../../public/css/light_mode.css">
    <% } %>
    <link rel="stylesheet" type="text/css" href="../../public/css/main.css">
    <link id="blur_base" rel="stylesheet" type="text/css" href="../../public/css/blur.css"
          <% if (!JSON.parse(appearance).blurEffects) { %>disabled
            <% } %>
    >
    <link id="blur_overrides" rel="stylesheet" type="text/css"
          href="public/css/<%= (theme ? "dark" : "light"); %>_blur.css"
          <% if (!JSON.parse(appearance).blurEffects) { %>disabled
            <% } %>
    >
    <link id="fade" rel="stylesheet" type="text/css" href="../../public/css/fade.css" disabled>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<!-- Admin Navbar -->
<% include ../partials/admin/admin_navbar.ejs %>

<!-- Main Screen -->
<div class="container">
    <!-- Messages -->
    <% if (adminSuccessMessage.length > 0) { %>
        <br>
        <div class="alert alert-danger alert-dismissible">
            <a class="close" data-dismiss="alert" aria-label="close">X</a>
            <%= adminSuccessMessage %>
        </div>
    <% } else if (adminFailMessage.length > 0) { %>
        <br>
        <div class="alert alert-success alert-dismissible">
            <a class="close" data-dismiss="alert" aria-label="close">X</a>
            <%= adminFailMessage %>
        </div>
    <% } else { %>
        <br>
    <% } %>

    <div id="table-container">
        <h6><%= userList.length %> Total Users,
            <% let uniqueUsers = userList.filter((u, i, a) => i === a.indexOf(a.find(d => u.schoolUsername === d.schoolUsername))) %>
            <%= uniqueUsers.length %> Unique Users,
            <%= uniqueUsers.filter(u => (u.loggedIn.length !== 0 && u.loggedIn.slice(-1)[0] > Date.parse(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate())))).length %>
            Logged In Today,
            <%= uniqueUsers.filter(u => (u.loggedIn.length !== 0 && u.loggedIn.slice(-1)[0] > Date.parse(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate())) - 7 * 24 * 60 * 60 * 1000)).length %>
            Logged In This Week
        </h6>
        <hr>
        <h1>Users</h1>
        <table class="table rounded-table" style="width: 100% !important;">
            <thead>
                <tr>
                    <th class="admin">Username</th>
                    <th class="admin">Name</th>
                    <th class="admin">Account Created</th>
                    <th class="admin">Last Logged In</th>
                    <th class="admin">Attributes</th>
                    <th class="admin">Render User Site</th>
                    <th class="admin">Delete User</th>
                    <th class="admin">Change Admin Privileges</th>
                </tr>
            </thead>

            <% for (let u of userList) { %>
                <tr>
                    <td class="admin"><%= u.username %> </td>
                    <td class="admin"><%= u.personalInfo.firstName + " " + u.personalInfo.lastName + " '" + (u.personalInfo.graduationYear - 2000) %></td>
                    <td class="admin">
                        <%= new Date(u.loggedIn[0]).toLocaleString("en-US", {timeZone: "America/Los_Angeles"}) ;%>
                    </td>
                    <td class="admin">
                        <% if (new Date(u.loggedIn.slice(-1)[0]).toLocaleString("en-US", {timeZone: "America/Los_Angeles"}) === "Invalid Date") { %>
                            Never Logged In
                        <% } else { %>
                            <%= new Date(u.loggedIn.slice(-1)[0]).toLocaleString("en-US", {timeZone: "America/Los_Angeles"}) %>
                        <% } %>
                    </td>
                    <td class="admin">
                        <% if (Object.keys(u).includes("schoolPassword")) { %> GradeSync<br>
                        <% } %>
                        <% if (u.isAdmin) { %> Admin<br>
                        <% } %>
                        <% if (new Date(u.alerts.termsLastSeen).toLocaleString("en-US", {timeZone: "America/Los_Angeles"}) === "Invalid Date") { %>
                            Terms not Seen<br>
                        <% } %>
                        <% if (new Date(u.alerts.policyLastSeen).toLocaleString("en-US", {timeZone: "America/Los_Angeles"}) === "Invalid Date") { %>
                            Policy not Seen<br>
                        <% } %>
                        <% if (u.betaFeatures.active) { %>
                            Beta<br>
                        <% } %>
                        <%= u.loggedIn.length; %> logins<br>
                        <%= u.alerts.lastUpdated.length; %> syncs
                    </td>
                    <td class="admin">
                        <% if (u.alerts.remoteAccess === "allowed") { %>
                            <form action="/viewuser" method="get" style="display: inline-block;">
                                <button type="submit" name="usernameToRender" class="btn btn-sm admin"
                                        value="<%= u.username; %>">
                                    Render User Site
                                </button>
                            </form>
                        <% } else { %>
                            Remote Access Denied
                        <% } %>
                    </td>
                    <td class="admin">
                        <% if (!u.isAdmin) { %>
                            <form action="/deleteuser" method="post">
                                <button type="submit" name="deleteUser" class="btn btn-sm admin"
                                        value="<%= u.username %>">Delete User
                                </button>
                            </form>
                        <% } else { %>
                            Cannot Delete Admin
                        <% } %>
                    </td>

                    <td class="admin">
                        <% if (u.username != username) { %>
                            <% if (u.isAdmin) { %>
                                <form action="/removeadmin" method="post">
                                    <button type="submit" name="removeAdminUser" class="btn btn-sm admin"
                                            value="<%= u.username %>">Remove Admin Privileges
                                    </button>
                                </form>
                            <% } else { %>
                                <form action="/makeadmin" method="post">
                                    <button type="submit" name="newAdminUser" class="btn btn-sm admin"
                                            value="<%= u.username %>">Make User Admin
                                    </button>
                                </form>
                            <% } %>
                        <% } else { %>
                            Cannot Remove Admin Privileges
                        <% } %>
                    </td>
                </tr>
            <% } %>
        </table>
        <hr>
        <h1>Deleted Users</h1>
        <table class="table rounded-table" style="width: 100% !important;">
            <thead>
                <tr>
                    <th class="admin">Username</th>
                    <th class="admin">School Username</th>
                    <th class="admin">Restore User</th>
                    <th class="admin">Delete Forever</th>
                </tr>
            </thead>

            <% for (let u of deletedUserList) { %>
                <tr>
                    <td class="admin"><%= u.username %> </td>
                    <td class="admin"><%= u.schoolUsername %></td>
                    <td class="admin">
                        <form action="/restoreUser" method="post">
                            <button type="submit" name="restoreUser" class="btn btn-sm admin"
                                    value="<%= u.username %>">Restore User
                            </button>
                        </form>
                    </td>
                    <td class="admin">
                        <form action="/deleteuser" method="post">
                            <button type="submit" name="deleteUser" class="btn btn-sm admin"
                                    value="<%= u.username %>">Delete Forever
                            </button>
                        </form>
                    </td>
                </tr>
            <% } %>
        </table>
    </div>
</div>
<script>
    let checkingTheme;
    let appearance = <%- appearance %>;
    let theme = appearance.theme;
    let darkModeStart = appearance.darkModeStart;
    let darkModeFinish = appearance.darkModeFinish;
    let sunrise = <%= sunrise.getTime() %>;
    let sunset = <%= sunset.getTime() %>;

    if (theme === "auto" || theme === "sun") {
        checkTime();
    }

    function setAutoTheme() {
        let zeroTime = new Date("0/");
        zeroTime.setHours(new Date().getHours());
        zeroTime.setMinutes(new Date().getMinutes());
        zeroTime = zeroTime.getTime();
        if (theme !== "auto" && theme !== "sun") {
            if (checkingTheme) {
                clearInterval(checkingTheme);
            }
            return;
        }
        if ((theme === "sun" && (zeroTime >= sunset || zeroTime <= sunrise)) || (theme === "auto" && (((darkModeStart < darkModeFinish) && ((zeroTime >= darkModeStart) && (zeroTime < darkModeFinish)) || ((darkModeStart > darkModeFinish) && ((zeroTime >= darkModeStart) || (zeroTime < darkModeFinish))))))) {
            let oldDarkMode = document.getElementById("pageStyle").getAttribute("href") === "../../public/css/dark_mode.css";
            darkMode = true;
            if (darkMode !== oldDarkMode) {
                document.getElementById("fade").disabled = false;
                document.getElementById("pageStyle").setAttribute("href", "../../public/css/dark_mode.css");
                if (appearance.blurEffects) {
                    document.getElementById("blur_overrides").setAttribute("href", "../../public/css/dark_blur.css");
                }
                $(".navbar-brand img").attr("src", "/public/resources/dark_mode/logo.png");
                $(".navbar").removeClass("navbar-light").addClass("navbar-dark");
                setTimeout(() => {
                    document.getElementById("fade").disabled = true;
                }, 500);
            }
        } else {
            let oldDarkMode = document.getElementById("pageStyle").getAttribute("href") === "../../public/css/dark_mode.css";
            darkMode = false;
            if (darkMode !== oldDarkMode) {
                document.getElementById("fade").disabled = false;
                document.getElementById("pageStyle").setAttribute("href", "../../public/css/light_mode.css");
                if (appearance.blurEffects) {
                    document.getElementById("blur_overrides").setAttribute("href", "../../public/css/light_blur.css");
                }
                $(".navbar-brand img").attr("src", "/public/resources/light_mode/logo.png");
                $(".navbar").removeClass("navbar-dark").addClass("navbar-light");
                setTimeout(() => {
                    document.getElementById("fade").disabled = true;
                }, 500);
            }
        }
        if (appearance.holidayEffects) {
            init = performance.now();
            $('#lights-disabled-message').hide();
            $('#snow-disabled-message').hide();
            $("#snow-fall").show();
            $(".lightrope").show();
            if (!darkMode) {
                $("#light_snowfall").attr("media", "");
            } else {
                $("#light_snowfall").attr("media", "not all");
            }
        } else {
            $('#lights-disabled-message').hide();
            $('#snow-disabled-message').hide();
            $("#snow-fall").hide();
            $(".lightrope").hide();
        }
    }

    async function checkTime() {
        if (checkingTheme) {
            clearInterval(checkingTheme);
        }
        setAutoTheme();
        checkingTheme = window.setInterval(function () {
            setAutoTheme();
        }, 100);
    }
</script>
</body>
</html>
