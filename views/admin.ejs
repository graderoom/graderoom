<!doctype html>
<html>
<head>
    <title>Graderoom</title>
    <link rel="icon" href="../public/resources/common/icon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:500&display=swap">
    <% if (user.appearance.theme === "dark" || (user.appearance.theme === "auto" && ((user.appearance.darkModeStart < user.appearance.darkModeFinish) && ((((Date.now() / 1000 / 3600 - 8) % 24) >= user.appearance.darkModeStart) && ((Date.now() / 1000 / 3600 - 8) % 24) < user.appearance.darkModeFinish)) || ((user.appearance.darkModeStart > user.appearance.darkModeFinish) && ((((Date.now() / 1000 / 3600 - 8) % 24) >= user.appearance.darkModeStart) || ((Date.now() / 1000 / 3600 - 8) % 24) < user.appearance.darkModeFinish)))) { %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="public/css/dark_mode.css">
    <% } else { %>
        <link id="pageStyle" rel="stylesheet" type="text/css" href="public/css/light_mode.css">
    <% } %>
    <link rel="stylesheet" type="text/css" href="public/css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<!-- Admin Navbar -->
<% include partials/admin/admin_navbar.ejs %>

<!-- Main Screen -->
<div class="container">
    <!-- Messages -->
    <% if (adminSuccessMessage.length > 0) { %>
        <br>
        <div class="alert alert-danger alert-dismissible">
            <a class="close" data-dismiss="alert" aria-label="close">X</a>
            <%= adminSuccessMessage %>
        </div>
    <% } else if (adminFailMessage.length > 0) { %>
        <br>
        <div class="alert alert-success alert-dismissible">
            <a class="close" data-dismiss="alert" aria-label="close">X</a>
            <%= adminFailMessage %>
        </div>
    <% } else { %>
        <br>
    <% } %>

    <form action="/bringAllUpToDate" method="post">
        <button class="btn btn-sm" type="submit">
            Bring All Users Up To Date
        </button>
    </form>
    <span id="table-container">
            <hr>
            <table class="table" style="width: 100% !important;">
                <thead>
                <tr>
                    <th style="width:15%;">Username</th>
                    <th style="width:15%;">Name</th>
                    <th style="width:15%;">Last Updated</th>
                    <th style="width:10%;">GradeSync?</th>
                    <th style="width:10%;">Is Admin?</th>
                    <th style="width:15%;">Render User Site</th>
                    <th style="width:15%;">Delete User</th>
                    <th style="width:15%;">Change Admin Privileges</th>
                </tr>
                </thead>

                <% for (let u of userList) { %>
                    <tr>
                        <td><%= u.username %> </td>
                        <td><%= u.schoolUsername.substring(0,1).toUpperCase() + u.schoolUsername.substring(1,u.schoolUsername.indexOf('.')) + ' ' + u.schoolUsername.substring(u.schoolUsername.indexOf('.') + 1,u.schoolUsername.indexOf('.') + 2).toUpperCase() + u.schoolUsername.substring(u.schoolUsername.indexOf('.') + 2, u.schoolUsername.indexOf('@') - 2) %></td>
                        <% let lastUpdated = new Date(u.alerts.lastUpdated); %>
                        <td><%= lastUpdated.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}) %></td>
                        <td><%= (Object.keys(u).includes("schoolPassword") ? "Enabled" : "Disabled") %></td>
                        <td><%= u.isAdmin %> </td>
                        <td>
                            <form action="/viewuser" method="get">
                                <button type="submit" name="usernameToRender" class="btn btn-sm"
                                        value="<%= u.username %>">
                                    Render User Site
                                </button>
                            </form>
                        </td>
                        <td>
                            <% if (!u.isAdmin) { %>
                                <form action="/deleteuser" method="post">
                                    <button type="submit" name="deleteUser" class="btn btn-sm"
                                            value="<%= u.username %>">Delete User</button>
                                </form>
                            <% } else { %>
                                Cannot Delete Admin
                            <% } %>
                        </td>

                        <td>
                            <% if (u != user) { %>
                                <% if (u.isAdmin) { %>
                                    <form action="/removeadmin" method="post">
                                        <button type="submit" name="removeAdminUser" class="btn btm-sm"
                                                value="<%= u.username %>">Remove Admin Privileges</button>
                                    </form>
                                <% } else { %>
                                    <form action="/makeadmin" method="post">
                                        <button type="submit" name="newAdminUser" class="btn btn-sm"
                                                value="<%= u.username %>">Make User Admin</button>
                                    </form>
                                <% } %>
                            <% } else { %>
                                Cannot Remove Admin Privileges
                            <% } %>
                        </td>
                    </tr>
                <% } %>
            </table>
        </span>
</div>
</body>
</html>
