<!-- Settings Card -->
<div class="container">
    <div class="blurred-login" id="updateWeightsDisplay" style="position:fixed; display:none; height: 100vh; width: 100%; top: 0; left: 0; z-index: 1">
        <div class="blurred-background" style="position: fixed; width: 100%; height: 100%; filter: opacity(0.9);"></div>
        <div id="weightsCard" class="card card-signin my-5 mx-auto" style="width: fit-content; max-height:90%; overflow:scroll;">
            <btn class="btn btn-md" onclick="hideDiv('updateWeightsDisplay')" style="width: fit-content; margin-bottom:0">
                <i class="fa fa-arrow-left" aria-hidden="true"></i>
                Cancel
            </btn>
            <div class="card-body" style="padding-top: 1em; padding-bottom: 1em;">  
                <h1 class="card-title text-center"><span class="fa fa-pencil"></span> Update Weights</h1>
                <span class="accordion" id="accordionForms">
                <% for (var i = 0; i<JSON.parse(gradeData).length; i++) {
                    let grade = JSON.parse(gradeData)[i]; %>
                    <form id="weights<%=i%>" class="form-ajax form-weights form-signin" action="/updateweights">
                        <h5 id="<%=grade.class_name%>" class="collapsed" data-toggle="collapse" href="#collapse<%=i%>">
                            <%=grade.class_name%>&nbsp;
                            <i class="fa" aria-hidden="true"></i>
                        </h5>
                        <span class="collapse" id="collapse<%=i%>" data-parent="#accordionForms"> 
                            <div style="width: 100%">
                                <div id="messages" class="alert alert-success alert-dismissible" style="width: fit-content; display:none;">
                                    <div id="message"></div>
                                    <a class="close" onClick="closeMessage()" aria-label="close">X</a>
                                </div>
                            </div>
                        <%  let weights = []; 
                            for (let assignment of grade.grades) { 
                                if (!(weights.includes(assignment.category))) {
                                    weights.push(assignment.category); %>
                                    <div class="form-group" style="display: flex; align-items: flex-end;">
                                        <label style="font-size: 0.9rem; color: #DDDDDD; white-space: nowrap; margin-bottom: 0;"><%=assignment.category%>:&nbsp</label>
                                        <% let value = ""; try {value = JSON.parse(weightData)[grade.class_name][assignment.category]} catch {}%>
                                        <input value='<%=value%>' style="font-size: 0.9rem; padding: .1rem .1rem; width: 3rem; text-align: center; margin-right: 1rem;" type="number" min="0" class="form-control" name="<%=assignment.category%>" required> 
                                    </div>
                                <% } %>
                            <% } %>
                            <div style="width: 100%">
                                <button type="submit" class="btn btn-default btn-med">
                                    <i class="fa fa-refresh" aria-hidden="true"></i>
                                    Update
                                </button>
                            </div>
                        </span>
                    </form>
                <% } %>
                </span>   
            </div>
        </div>
    </div>
</div>

<script>
    function showUpdateWeights(defaultId) {
        if (defaultId === undefined) 
            defaultId = 0;
        showDiv('updateWeightsDisplay');
        $('#collapse'+defaultId).collapse('show');    
    } 

    $(function initAjaxFormPosts() {
        if ($("form.form-weights").length > 0) {
            $("form.form-weights").each(function () {
                var form = $(this);
                $(form).submit(function(event) {
                    event.preventDefault();
                    let weightData = (($(form).serializeArray()));
                    let weightURI = {};
                    jQuery.map(weightData, function (n, i) {
                        weightURI[n.name] = parseInt(n.value);
                    });
                    weightURI = encodeURIComponent(JSON.stringify(weightURI));
                    console.log(weightURI);
                    let className = encodeURI($(form).find('h5').attr('id'));
                    formData = "className="+className+"&newWeights="+weightURI;

                    let formMessagesDiv = $(this).find('#messages');
                    let message = $(this).find('#message');

                    $.ajax({
                        type: 'POST',
                        url: $(form).attr('action'),
                        data: formData
                    })
                    .done(function(response) {
                        // Make sure that the formMessages div has the alert-success class.
                        $(formMessagesDiv).removeClass('alert-danger');
                        $(formMessagesDiv).addClass('alert-success');

                        // Set the message text.
                        $(message).text(response);

                        // Show the div.
                        $(formMessagesDiv).css('display','block');

                        console.log("it worked");
                    })

                    .fail(function(data) {
                        //Make sure that the formMessages div has the alert-danger class
                        $(formMessagesDiv).removeClass('alert-success');
                        $(formMessagesDiv).addClass('alert-danger');

                        // Set the message text.
                        if (data.responseText !== '') {
                            $(message).text(data.responseText);
                        } else {
                            $(message).text('Oops! An error occurred and your message could not be sent.');
                        }

                        // Show the div.
                        $(formMessagesDiv).css('display','block');
                    })
                })
            });
        }
    })
</script>